<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar <%= entidadeLabel %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <% const returnToEncoded = encodeURIComponent(returnToAtual || withBase('/admin/' + tabela + '?token=' + token)); %>
    <main class="container py-4 py-md-5">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
                    <div>
                        <h1 class="h4 mb-1">
                            <i class="fa-solid fa-list-ul text-primary me-2"></i><%= entidadeLabel %>
                        </h1>
                        <p class="text-muted mb-0 small">
                            Exibindo <strong><%= paginacao.inicio %></strong> a <strong><%= paginacao.fim %></strong> de <strong><%= paginacao.totalRegistros %></strong> registros.
                        </p>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="<%= withBase('/admin?token=' + token) %>" class="btn btn-outline-secondary">
                            <i class="fa-solid fa-arrow-left me-1"></i>Voltar
                        </a>
                        <% if (usuarioLogado.tipo !== 'nap') { %>
                            <a href="<%= withBase('/admin/' + tabela + '/novo?token=' + token + '&return_to=' + returnToEncoded) %>" class="btn btn-primary">
                                <i class="fa-solid fa-plus me-1"></i>Novo Registro
                            </a>
                        <% } %>
                    </div>
                </div>

                <form action="<%= withBase('/admin/' + tabela) %>" method="GET" class="row g-2 g-md-3 mb-4">
                    <input type="hidden" name="token" value="<%= token %>">

                    <div class="col-12 col-md-4">
                        <label class="form-label small text-muted">Busca</label>
                        <input
                            type="text"
                            name="q"
                            class="form-control"
                            placeholder="Buscar..."
                            value="<%= filtros.q || '' %>"
                        >
                    </div>

                    <% if (tabela === 'turmas') { %>
                        <div class="col-12 col-md-3">
                            <label class="form-label small text-muted">Curso</label>
                            <select name="filtro_curso" class="form-select">
                                <option value="">Todos</option>
                                <% cursosFiltro.forEach(c => { %>
                                    <option value="<%= c.id %>" <%= filtros.filtro_curso == c.id ? 'selected' : '' %>><%= c.nome %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label small text-muted">Unidade</label>
                            <select name="filtro_unidade" class="form-select">
                                <option value="">Todas</option>
                                <% unidadesFiltro.forEach(u => { %>
                                    <option value="<%= u.unidade %>" <%= filtros.filtro_unidade == u.unidade ? 'selected' : '' %>><%= u.unidade %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="col-12 col-md-2">
                            <label class="form-label small text-muted">Turno</label>
                            <select name="filtro_turno" class="form-select">
                                <option value="">Todos</option>
                                <% turnosFiltro.forEach(t => { %>
                                    <option value="<%= t.id %>" <%= filtros.filtro_turno == t.id ? 'selected' : '' %>><%= t.nome %></option>
                                <% }) %>
                            </select>
                        </div>
                    <% } %>

                    <div class="col-12 col-md-2">
                        <label class="form-label small text-muted">Por página</label>
                        <select name="per_page" class="form-select">
                            <option value="10" <%= filtros.per_page == 10 ? 'selected' : '' %>>10</option>
                            <option value="20" <%= filtros.per_page == 20 ? 'selected' : '' %>>20</option>
                            <option value="50" <%= filtros.per_page == 50 ? 'selected' : '' %>>50</option>
                        </select>
                    </div>

                    <div class="col-12 d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-filter me-1"></i>Aplicar
                        </button>
                        <a href="<%= withBase('/admin/' + tabela + '?token=' + token) %>" class="btn btn-outline-secondary">
                            <i class="fa-solid fa-rotate-left me-1"></i>Limpar
                        </a>
                    </div>
                </form>

                <% if (itens.length === 0) { %>
                    <div class="alert alert-info mb-0">Nenhum registro encontrado para os filtros informados.</div>
                <% } else { %>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">ID</th>
                                    <th>Detalhes</th>
                                    <th class="text-end" style="width: 220px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% itens.forEach(item => { %>
                                    <tr>
                                        <td class="text-muted fw-semibold">#<%= item.id %></td>
                                        <td>
                                            <% if (tabela === 'turmas') { %>
                                                <div class="fw-semibold"><%= item.nome %></div>
                                                <div class="small text-muted d-flex flex-wrap gap-2 mt-1">
                                                    <span class="badge text-bg-light border">Semestre: <%= item.semestre_ref || '-' %></span>
                                                    <span class="badge text-bg-light border">Unidade: <%= item.unidade || '-' %></span>
                                                    <span class="badge text-bg-light border">Curso: <%= item.curso_nome || '-' %></span>
                                                    <span class="badge text-bg-light border">Turno: <%= item.turno_nome || '-' %></span>
                                                </div>
                                            <% } else if (tabela === 'usuarios') { %>
                                                <div class="fw-semibold"><%= item.nome %></div>
                                                <div class="small text-muted"><%= item.email %></div>
                                                <div class="small text-muted d-flex flex-wrap gap-2 mt-1">
                                                    <span class="badge text-bg-secondary text-uppercase"><%= item.tipo %></span>
                                                    <% if (item.curso_nome) { %><span class="badge text-bg-light border">Curso: <%= item.curso_nome %></span><% } %>
                                                    <% if (item.unidade_responsavel) { %><span class="badge text-bg-light border">Unidade: <%= item.unidade_responsavel %></span><% } %>
                                                </div>
                                            <% } else if (tabela === 'cursos') { %>
                                                <div class="fw-semibold"><%= item.nome %></div>
                                                <div class="small text-muted d-flex flex-wrap gap-2 mt-1">
                                                    <span class="badge text-bg-light border">Coord.: <%= item.coordenador || '-' %></span>
                                                    <span class="badge text-bg-light border">Semestres: <%= item.semestres_total || '-' %></span>
                                                </div>
                                            <% } else if (tabela === 'turnos') { %>
                                                <div class="fw-semibold"><%= item.nome %></div>
                                                <div class="small text-muted d-flex flex-wrap gap-2 mt-1">
                                                    <span class="badge text-bg-light border">Slug: <%= item.slug || '-' %></span>
                                                    <span class="badge text-bg-light border">Ordem: <%= item.ordem || '-' %></span>
                                                </div>
                                            <% } else { %>
                                                <div class="fw-semibold"><%= item.nome || item.descricao %></div>
                                            <% } %>
                                        </td>
                                        <td class="text-end">
                                            <% if (tabela === 'turmas') { %>
                                                <a href="<%= withBase('/admin/turmas/' + item.id + '/grade?token=' + token + '&return_to=' + returnToEncoded) %>" class="btn btn-sm btn-warning me-1">
                                                    <i class="fa-solid fa-table me-1"></i><%= usuarioLogado.tipo === 'nap' ? 'Salas' : 'Grade' %>
                                                </a>
                                            <% } %>
                                            <% if (usuarioLogado.tipo !== 'nap') { %>
                                                <a href="<%= withBase('/admin/' + tabela + '/editar/' + item.id + '?token=' + token + '&return_to=' + returnToEncoded) %>" class="btn btn-sm btn-info text-white me-1">
                                                    <i class="fa-solid fa-pen"></i>
                                                </a>
                                                <form action="<%= withBase('/admin/' + tabela + '/excluir/' + item.id + '?token=' + token + '&return_to=' + returnToEncoded) %>" method="POST" class="d-inline" onsubmit="return confirm('Excluir este registro?');">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                                        <i class="fa-solid fa-trash"></i>
                                                    </button>
                                                </form>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } %>

                <% if (paginacao.totalPaginas > 1) { %>
                    <nav class="mt-4" aria-label="Paginação">
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item <%= paginacao.paginaAtual === 1 ? 'disabled' : '' %>">
                                <a class="page-link" href="<%= withBase('/admin/' + tabela + '?' + queryBase + '&page=' + (paginacao.paginaAtual - 1)) %>">Anterior</a>
                            </li>

                            <% 
                                const inicio = Math.max(1, paginacao.paginaAtual - 2);
                                const fim = Math.min(paginacao.totalPaginas, paginacao.paginaAtual + 2);
                                for(let p = inicio; p <= fim; p++) { 
                            %>
                                <li class="page-item <%= p === paginacao.paginaAtual ? 'active' : '' %>">
                                    <a class="page-link" href="<%= withBase('/admin/' + tabela + '?' + queryBase + '&page=' + p) %>"><%= p %></a>
                                </li>
                            <% } %>

                            <li class="page-item <%= paginacao.paginaAtual === paginacao.totalPaginas ? 'disabled' : '' %>">
                                <a class="page-link" href="<%= withBase('/admin/' + tabela + '?' + queryBase + '&page=' + (paginacao.paginaAtual + 1)) %>">Próxima</a>
                            </li>
                        </ul>
                    </nav>
                <% } %>
            </div>
        </div>
    </main>
</body>
</html>
